<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <title>Peta GPS Desa - Live Tracking</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        html, body { margin:0; padding:0; font-family: sans-serif; }
        #map { width:100%; height:100vh; }
        
        /* Panel Tombol */
        .panel { position:absolute; top:10px; right:10px; z-index:1000; display:flex; flex-direction:column; gap:6px; }
        .panel button { background:#ffffff; border:1px solid #ccc; border-radius:6px; padding:12px; font-size:13px; cursor:pointer; font-weight:bold; box-shadow:0 2px 4px rgba(0,0,0,.2); }
        
        /* Legenda */
        .legend { position:absolute; bottom:25px; left:10px; background:rgba(255,255,255,0.9); padding:10px; font-size:11px; z-index:1000; border-radius:6px; border:1px solid #999; line-height: 1.5; }
        
        /* Icon Posisi Biru */
        .pulse-blue { width:18px; height:18px; background:#007bff; border:2px solid white; border-radius:50%; position:relative; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .pulse-blue::after { content:""; position:absolute; left:-2px; top:-2px; width:18px; height:18px; border-radius:50%; background:rgba(0,123,255,0.4); animation:pulse 1.5s ease-out infinite; }
        @keyframes pulse { 0%{transform:scale(1);opacity:1;} 100%{transform:scale(3);opacity:0;} }
    </style>
</head>
<body>

<div id="map"></div>

<div class="panel">
    <button onclick="goToMe()">üß≠ POSISI SAYA</button>
    <button onclick="toggleFollow()">üìç IKUTI SAYA</button>
</div>

<div class="legend">
    üî¥ Titik Target (Besar + Nama Real)<br>
    üîµ Posisi Anda (Alarm Aktif < 700m)<br>
    <small><i>Note: Klik layar 1x untuk aktifkan suara</i></small>
</div>

<script>
// 1. Inisialisasi Peta
var map = L.map('map').setView([-0.98, 113.9], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
}).addTo(map);

// 2. Sistem Suara Alarm
var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playBeep() {
    var osc = audioCtx.createOscillator();
    var gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.type = 'sine'; osc.frequency.setValueAtTime(1000, audioCtx.currentTime);
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    osc.start(); osc.stop(audioCtx.currentTime + 0.15);
}

function alarm5x() {
    let c = 0; 
    let i = setInterval(() => { 
        playBeep(); c++; 
        if(c >= 5) clearInterval(i); 
    }, 350);
}

// 3. Data 107 Lokasi
var locations = [
    {id:1, latlng: [-0.9398683,113.9983633]}, {id:2, latlng: [-0.9396475,113.997305]}, {id:3, latlng: [-0.9396131,113.9963251]}, 
    {id:4, latlng: [-0.9400508,113.9958913]}, {id:5, latlng: [-0.9426341,113.9922969]}, {id:6, latlng: [-0.9443269,113.989899]}, 
    {id:7, latlng: [-0.945568,113.9900075]}, {id:8, latlng: [-0.9478702,113.9875902]}, {id:9, latlng: [-0.9481333,113.984495]}, 
    {id:10, latlng: [-0.9490799,113.9829559]}, {id:11, latlng: [-0.9496681,113.9817438]}, {id:12, latlng: [-0.950279,113.9815748]}, 
    {id:13, latlng: [-0.9507502,113.9796011]}, {id:14, latlng: [-0.9509111,113.9789807]}, {id:15, latlng: [-0.9515162,113.9746019]}, 
    {id:16, latlng: [-0.9507802,113.9736127]}, {id:17, latlng: [-0.9501424,113.9728017]}, {id:18, latlng: [-0.9509645,113.9716935]}, 
    {id:19, latlng: [-0.9516382,113.9693287]}, {id:20, latlng: [-0.9562016,113.9678527]}, {id:21, latlng: [-0.9589516,113.967487]}, 
    {id:22, latlng: [-0.9622463,113.9653863]}, {id:23, latlng: [-0.9645443,113.96476]}, {id:24, latlng: [-0.9658818,113.962869]}, 
    {id:25, latlng: [-0.9712135,113.9583235]}, {id:26, latlng: [-0.9732324,113.9576436]}, {id:27, latlng: [-0.9764483,113.95879]}, 
    {id:28, latlng: [-0.9796551,113.9589544]}, {id:29, latlng: [-0.9802581,113.95996]}, {id:30, latlng: [-0.9807984,113.9610812]}, 
    {id:31, latlng: [-0.9853007,113.9630436]}, {id:32, latlng: [-0.9908578,113.963157]}, {id:33, latlng: [-0.99576,113.961514]}, 
    {id:34, latlng: [-0.99640991,113.96037519]}, {id:35, latlng: [-0.998942,113.9586848]}, {id:36, latlng: [-1.0019681,113.9573841]}, 
    {id:37, latlng: [-1.0049293,113.9578595]}, {id:38, latlng: [-1.0062289,113.9576941]}, {id:39, latlng: [-1.0068049,113.9576488]}, 
    {id:40, latlng: [-1.0119795,113.9556548]}, {id:41, latlng: [-1.0210327,113.9521815]}, {id:42, latlng: [-1.0221569,113.9501734]}, 
    {id:43, latlng: [-1.0230672,113.9504812]}, {id:44, latlng: [-1.0242539,113.9497533]}, {id:45, latlng: [-1.0255202,113.949793]}, 
    {id:46, latlng: [-1.0276017,113.9473637]}, {id:47, latlng: [-1.0286273,113.9460514]}, {id:48, latlng: [-1.029966,113.9458089]}, 
    {id:49, latlng: [-1.0307193,113.9450336]}, {id:50, latlng: [-1.0317172,113.9445392]}, {id:51, latlng: [-1.0340786,113.9440997]}, 
    {id:52, latlng: [-1.0352266,113.9439115]}, {id:53, latlng: [-1.0363828,113.9439575]}, {id:54, latlng: [-1.0374275,113.9434912]}, 
    {id:55, latlng: [-1.0397686,113.9433359]}, {id:56, latlng: [-1.0412295,113.9423898]}, {id:57, latlng: [-1.0420347,113.9422273]}, 
    {id:58, latlng: [-1.0427202,113.9413728]}, {id:59, latlng: [-1.0434827,113.9405541]}, {id:60, latlng: [-1.0448959,113.939752]}, 
    {id:61, latlng: [-1.0467699,113.9400067]}, {id:62, latlng: [-1.0475123,113.9395898]}, {id:63, latlng: [-1.049294,113.9384091]}, 
    {id:64, latlng: [-1.0536566,113.9371957]}, {id:65, latlng: [-1.05477,113.936485]}, {id:66, latlng: [-1.0562356,113.9364062]}, 
    {id:67, latlng: [-1.0582165,113.9359371]}, {id:68, latlng: [-1.0591312,113.9352778]}, {id:69, latlng: [-1.060256,113.9346623]}, 
    {id:70, latlng: [-1.0607245,113.9319475]}, {id:71, latlng: [-1.060455,113.9290695]}, {id:72, latlng: [-1.0617759,113.9267933]}, 
    {id:73, latlng: [-1.0623948,113.9262709]}, {id:74, latlng: [-1.0651755,113.9243126]}, {id:75, latlng: [-1.065617,113.9231727]}, 
    {id:76, latlng: [-1.0664368,113.9208059]}, {id:77, latlng: [-1.0679874,113.9186049]}, {id:78, latlng: [-1.0698009,113.9168659]}, 
    {id:79, latlng: [-1.0705797,113.9158323]}, {id:80, latlng: [-1.071894,113.9144727]}, {id:81, latlng: [-1.0732005,113.9132818]}, 
    {id:82, latlng: [-1.0747691,113.9098664]}, {id:83, latlng: [-1.075034,113.9072548]}, {id:84, latlng: [-1.0758168,113.9053506]}, 
    {id:85, latlng: [-1.0760139,113.9041949]}, {id:86, latlng: [-1.0764097,113.9023165]}, {id:87, latlng: [-1.0772565,113.9001918]}, 
    {id:88, latlng: [-1.0777814,113.8985109]}, {id:89, latlng: [-1.0779541,113.8967136]}, {id:90, latlng: [-1.0784635,113.8955646]}, 
    {id:91, latlng: [-1.078725,113.8941187]}, {id:92, latlng: [-1.0795339,113.8921079]}, {id:93, latlng: [-1.0805781,113.890319]}, 
    {id:94, latlng: [-1.0814819,113.8878399]}, {id:95, latlng: [-1.0816308,113.8869932]}, {id:96, latlng: [-1.0820327,113.8851276]}, 
    {id:97, latlng: [-1.0823924,113.8837585]}, {id:98, latlng: [-1.0829072,113.8833311]}, {id:99, latlng: [-1.0838205,113.8816435]}, 
    {id:100, latlng: [-1.083747,113.8801259]}, {id:101, latlng: [-1.0842773,113.8790922]}, {id:102, latlng: [-1.086053,113.8771372]}, 
    {id:103, latlng: [-1.0873728,113.8753825]}, {id:104, latlng: [-1.0885204,113.872688]}, {id:105, latlng: [-1.0890845,113.8716607]}, 
    {id:106, latlng: [-1.0895748,113.8705911]}, {id:107, latlng: [-1.0913175,113.8691019]}, {id:108, latlng: [-1.0919588,113.868948]}
];

var markers = [];
var bounds = [];

// 4. Fungsi Mencari Nama Desa Real-Time
async function getVillageName(lat, lng) {
    try {
        let resp = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1`);
        let data = await resp.json();
        let a = data.address;
        return a.village || a.town || a.city_district || a.suburb || a.county || "Lokasi Luar Desa";
    } catch (e) { return "Titik Survei"; }
}

// 5. Render Titik Merah (+20% size)
locations.forEach(async function(loc){
    bounds.push(loc.latlng);
    var m = L.circleMarker(loc.latlng, {
        radius: 4, // Diperbesar
        fillColor: 'red', color: 'darkred', weight: 1, fillOpacity: 0.8
    }).addTo(map).bindPopup("Memuat nama lokasi...");
    
    // Cari nama desa asli
    let realName = await getVillageName(loc.latlng[0], loc.latlng[1]);
    m.setPopupContent(`<b>Desa: ${realName}</b><br>ID: ${loc.id}`);
    
    markers.push({name: realName, latlng: L.latLng(loc.latlng), marker: m, alerted: false});
});

if(bounds.length) map.fitBounds(bounds);

// 6. Tracking Posisi User (Biru)
var lastUserPos = null;
var liveMarker = null;
var followMode = false;
var blueIcon = L.divIcon({ className:'', html:'<div class="pulse-blue"></div>', iconSize:[18,18], iconAnchor:[9,9] });

if(navigator.geolocation){
    navigator.geolocation.watchPosition(function(pos){
        var userPos = L.latLng(pos.coords.latitude, pos.coords.longitude);
        lastUserPos = userPos;

        if(liveMarker) map.removeLayer(liveMarker);
        liveMarker = L.marker(userPos, {icon:blueIcon}).addTo(map);

        if(followMode) map.setView(userPos, map.getZoom());

        // Logika Alarm Jarak 700 Meter
        markers.forEach(function(target){
            var distance = userPos.distanceTo(target.latlng);
            if(distance <= 700 && !target.alerted){
                target.alerted = true;
                target.marker.openPopup();
                target.marker.setPopupContent(`<b>‚ö†Ô∏è DEKAT LOKASI!</b><br>Desa: ${target.name}<br>Jarak: ${Math.round(distance)}m`);
                alarm5x();
            } else if (distance > 1000) {
                target.alerted = false; // Reset agar bisa bunyi lagi nanti
            }
        });
    }, null, {enableHighAccuracy:true});
}

// 7. Fungsi Navigasi
function goToMe(){ if(lastUserPos) map.setView(lastUserPos, 15); }
function toggleFollow(){ 
    followMode = !followMode; 
    alert(followMode ? "Mode Ikuti AKTIF" : "Mode Ikuti MATI"); 
}
</script>
</body>
</html>
