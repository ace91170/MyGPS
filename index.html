<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <title>Peta Monitoring GPS - Auto Alarm</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        html, body { margin:0; padding:0; font-family: sans-serif; overflow: hidden; }
        #map { width:100%; height:100vh; }
        
        /* Overlay Awal untuk Izin Audio */
        #start-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; text-align: center; cursor: pointer;
        }
        .start-btn {
            background: #28a745; color: white; border: none; padding: 20px 40px;
            font-size: 20px; border-radius: 50px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .panel { position:absolute; top:10px; right:10px; z-index:1000; display:flex; flex-direction:column; gap:8px; }
        .panel button { 
            background:#ffffff; border:none; border-radius:8px; padding:12px 15px; 
            font-size:12px; cursor:pointer; font-weight:bold; box-shadow:0 4px 6px rgba(0,0,0,0.1);
        }
        .legend { 
            position:absolute; bottom:25px; left:10px; background:rgba(255,255,255,0.9); 
            padding:12px; font-size:11px; z-index:1000; border-radius:8px; border:1px solid #ccc;
        }
        .pulse-blue { 
            width:16px; height:16px; background:#007bff; border:3px solid white; 
            border-radius:50%; position:relative; box-shadow: 0 0 8px rgba(0,0,0,0.3); 
        }
        .pulse-blue::after { 
            content:""; position:absolute; left:-3px; top:-3px; width:16px; height:16px; 
            border-radius:50%; background:rgba(0,123,255,0.4); animation:pulse 1.8s ease-out infinite; 
        }
        @keyframes pulse { 0%{transform:scale(1);opacity:1;} 100%{transform:scale(3.5);opacity:0;} }
    </style>
</head>
<body>

<div id="start-overlay" onclick="startSystem()">
    <button class="start-btn">KLIK UNTUK AKTIFKAN PETA & ALARM</button>
    <p style="margin-top:20px;">Izin akses lokasi dan audio diperlukan.</p>
</div>

<div id="map"></div>

<div class="panel">
    <button onclick="goToMe()">üß≠ POSISI SAYA</button>
    <button id="followBtn" onclick="toggleFollow()" style="background:#d4edda">üìç IKUTI SAYA: ON</button>
</div>

<div class="legend">
    <strong>Sistem Monitoring GPS</strong><br>
    üî¥ Titik Target (Alarm AKTIF)<br>
    üîµ Posisi Anda<br>
    <hr>
    Status: <span id="status" style="color:green; font-weight:bold;">Sistem Standby</span>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
var map = L.map('map', { zoomControl: false }).setView([-1.04, 113.92], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
L.control.zoom({ position: 'bottomright' }).addTo(map);

var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
var isFollowing = true; // Default ON
var userMarker = null, lastPos = null;
var targets = [];
var seen = new Set();

// 1. Data Koordinat (Unik)
var rawLocations = [
    [-0.9398683, 113.9983633], [-0.9396475, 113.997305], [-0.9396131, 113.9963251], 
    [-0.9400508, 113.9958913], [-0.9426341, 113.9922969], [-0.9443269, 113.989899], 
    [-0.945568, 113.9900075], [-0.9478702, 113.9875902], [-0.9481333, 113.984495], 
    [-0.9490799, 113.9829559], [-1.0885204, 113.872688], [-1.0919588, 113.868948],
    [-2.158995, 113.942723] // Titik Palangkaraya
    // ... [Koordinat lainnya otomatis terfilter jika dobel]
];

// 2. Fungsi Jalankan Sistem (Setelah Klik)
function startSystem() {
    if(audioCtx.state === 'suspended') audioCtx.resume();
    document.getElementById('start-overlay').style.display = 'none';
    initGeolocation();
}

function playBeep() {
    var osc = audioCtx.createOscillator();
    var gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.type = 'sine'; osc.frequency.setValueAtTime(880, audioCtx.currentTime);
    gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
    osc.start(); osc.stop(audioCtx.currentTime + 0.3);
}

// 3. Render Marker Unik
rawLocations.forEach(coord => {
    let key = coord[0].toFixed(6) + "," + coord[1].toFixed(6);
    if (!seen.has(key)) {
        seen.add(key);
        var marker = L.circleMarker(coord, {
            radius: 6, fillColor: 'red', color: 'darkred', weight: 1, fillOpacity: 0.8
        }).addTo(map);
        targets.push({ latlng: L.latLng(coord), marker: marker, alerted: false });
    }
});

// 4. Geolocation Logic
function initGeolocation() {
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(pos => {
            var latlng = L.latLng(pos.coords.latitude, pos.coords.longitude);
            lastPos = latlng;

            if (!userMarker) {
                userMarker = L.marker(latlng, { 
                    icon: L.divIcon({ className:'', html:'<div class="pulse-blue"></div>', iconAnchor:[8,8] }) 
                }).addTo(map);
            } else {
                userMarker.setLatLng(latlng);
            }

            if (isFollowing) map.setView(latlng, 15);

            // Cek Jarak Alarm (Otomatis ON)
            targets.forEach(t => {
                let dist = latlng.distanceTo(t.latlng);
                if (dist < 700 && !t.alerted) {
                    t.alerted = true;
                    t.marker.openPopup();
                    playBeep(); // Alarm bunyi otomatis
                } else if (dist > 1000) {
                    t.alerted = false;
                }
            });
            document.getElementById('status').innerText = "Sistem Aktif";
        }, err => alert("Aktifkan GPS Anda"), { enableHighAccuracy: true });
    }
}

function goToMe() { if (lastPos) map.setView(lastPos, 15); }

function toggleFollow() {
    isFollowing = !isFollowing;
    document.getElementById('followBtn').innerText = isFollowing ? "üìç IKUTI SAYA: ON" : "üìç IKUTI SAYA: OFF";
    document.getElementById('followBtn').style.background = isFollowing ? "#d4edda" : "#fff";
}
</script>
</body>
</html>
